suite: test ingress with Kubernetes 1.19
templates:
  - ingress.yaml
tests:
  - it: should work
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      config:
        rpcAddress: "rpcAddress_value"
        smartContractAddress: "smartContractAddress_value"
        smartContractAbi: "smartContractAbi_value"
      secrets:
        orgAccountJson: "{ \"key\": \"value\" }"
      ingress:
        enabled: true
        className: "className_test"
        annotations:
          annotation_1: "annotation_1_test"
          annotation_2: "annotation_2_test"
        hosts:
          - host: host_test
            paths:
              - path: /path_test
                pathType: pathType_test
    asserts:
      - isKind:
          of: Ingress
      - matchRegex:
          path: metadata.name
          pattern: -ethadapter$
      # ingressClassName should be set for >= 1.18
      - equal:
          path: spec.ingressClassName
          value: className_test
      # annotation should not be set
      - isNull:
          path: metadata.annotations.kubernetes\.io/ingress\.class
          value: className_test
      - equal:
          path: metadata.annotations.annotation_1
          value: annotation_1_test
      - equal:
          path: metadata.annotations.annotation_2
          value: annotation_2_test
      - equal:
          path: spec.rules[0].host
          value: host_test
      # Pathtype must be for >= 1.18
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: pathType_test
      # backend.service must not be set before 1.19
      - isNotNull:
          path: spec.rules[0].http.paths[0].backend.service
      # Old backend schema must not used for >= 1.19
      - isNull:
          path: spec.rules[0].http.paths[0].backend.serviceName
      - isNull:
          path: spec.rules[0].http.paths[0].backend.servicePort
          value: 3000
      # Instead use new schema with service.name and sevice.port
      - matchRegex:
          path: spec.rules[0].http.paths[0].backend.service.name
          pattern: -ethadapter$
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port
          value: 3000
